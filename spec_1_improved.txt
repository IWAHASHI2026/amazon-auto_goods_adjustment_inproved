# Amazon 広告（スポンサープロダクト）入札調整アプリ 仕様書（Claude Code 依頼用）

Amazon広告の Bulk（.xlsx）ファイルをアップロードすると、指定ルールに従って入札額（Bid）を調整し、調整済みの .xlsx をダウンロードできるWebアプリを作る。

---

## 1. 入出力

### 入力
- Amazon からダウンロードした **.xlsx（Excel）ファイルのみ**（CSVは非対応）
- アップロードされたファイル内に **「スポンサープロダクト広告キャンペーン」** というシートが存在する前提
  - 存在しない場合は、ユーザーに「対象シートが見つからない」旨を分かりやすく表示し、処理を中断する

### 出力
- **.xlsx（Excel）** で出力
- 出力は「スポンサープロダクト広告キャンペーン」シートを含む
- **フィルター条件に一致しない行は削除して出力する**（＝“商品ターゲティング”以外は出力しない）

---

## 2. 対象シート・対象列の特定方法（重要）

### 対象シート
- シート名：**スポンサープロダクト広告キャンペーン**

### 列の特定
- **列記号（A列/B列/C列）で固定せず、ヘッダー名で特定すること。**
- 必須列（ヘッダー名で特定）：
  - フィルター列：B列相当（※下記「商品ターゲティング」判定に使う列。Amazonの実ファイルで該当ヘッダー名を確認して実装する）
  - ROAS 列（ヘッダー名は実ファイルで確認して特定）
  - クリック数 列（ヘッダー名は実ファイルで確認して特定）
  - 入札額 列（ヘッダー名は実ファイルで確認して特定）
  - 操作 列：ヘッダー名 **「操作」**（ここへ "update" を入れる）

> ※Amazonの実ファイルの列名（日本語/英語表記など）は揺れる可能性があるため、実ファイルを見て「どのヘッダー名を採用するか」を決め、必要ならユーザーに確認すること。

---

## 3. 変換処理（手順）

1. アップロードされた .xlsx を読み込む
2. シート「スポンサープロダクト広告キャンペーン」を取得する
3. 対象列（フィルター/ROAS/クリック数/入札額/操作）をヘッダー名で特定する
4. フィルター処理
   - フィルター対象列（B列相当）の値が **「商品ターゲティング」** の行だけを残す（完全一致）
   - それ以外の行は **削除** する
5. 入札額をルールに従って調整（フィルター後に残った行のみ）
6. 「操作」列（ヘッダー名：操作）に **"update"** を代入（フィルター後に残った行のみ、ヘッダー行を除く）
7. 調整後の .xlsx を生成してダウンロード可能にする

---

## 4. 数値の扱い（例外処理・丸め）

- ROAS / クリック数 / 入札額 は数値として扱う
- **空欄は 0 扱い**（例："" / null は 0）
- 数値変換できない文字列（例："--"）が来た場合も 0 扱いにする（安全側）
- 入札額の調整後は次を必ず満たす：
  - 最小値：**1**
  - 最大値：**200**
  - 範囲外になったら **clamp（下限・上限で丸め）** する
- 入札額の小数点の扱い：
  - 入札額は小数を許容し、**小数第2位で四捨五入**（例：Math.round(x * 100) / 100）

---

## 5. 入札額調整ルール（固定5本・パラメータ編集可）

### ルールの前提
- 調整は **差分（Δ）** で行う（絶対値ではない）
- ルール適用後の入札額は次で計算する：
  - **入札額 = 入札額 + Δ**

### ルール（デフォルト値）
クリック閾値（デフォルト）：30  
ROAS境界（デフォルト）：3 / 6  
Δ（デフォルト）：下記の通り

1) **ROAS == 0 かつ Clicks <= 30**：Δ = -1  
2) **ROAS == 0 かつ Clicks > 30**：Δ = -7  
3) **0 < ROAS < 3**：Δ = -5  
4) **3 <= ROAS < 6**：Δ = 0（変更なし）  
5) **ROAS >= 6**：Δ = +3  

> 境界は明確に上記の不等号で実装する（ROAS=3 は 4)、ROAS=6 は 5)）。

---

## 6. UI要件

### 6.1 基本画面
- ファイルアップロード（.xlsx のみ）
- 処理中の表示（スピナー等）
- 成功時：ダウンロードボタン
- エラー時：ユーザーが理解できる文言（例：対象シートがない、必須列が見つからない、など）

### 6.2 ルール編集UI（必須）
- ルールの **数は固定（上記5本）** とする
- ただし以下は **UIで編集可能** にする：
  - クリック閾値（デフォルト30）
  - ROAS境界（デフォルト3 / 6）
  - 各ルールの Δ（-1 / -7 / -5 / 0 / +3）
- バリデーション例：
  - クリック閾値：0以上の整数
  - ROAS境界：0以上、かつ lower < upper
  - Δ：数値（小数可）
- 変更後のルールで再処理できる導線（例：「適用」ボタン）

### 6.3 デザイン
- React + Tailwind CSS + shadcn を中心に構成
- レスポンシブ対応（スマホでも崩れない）
- アニメーションは **最小限**（例：モーダル開閉、トースト等に限定。大量行レンダリングにアニメーションは使わない）
- ダークモードは非対応

---

## 7. 制約事項
- DBは使わない（ローカル処理）
- Core Web Vitals を意識し、軽快に動くUI（特に大きいExcelを想定）
- コメントはすべて日本語

---

## 8. 実装の流れ（固定）

1. 既存の雛形/リポジトリ構成を把握する（新規ならテンプレ選定を含む）
2. ESLint をセットアップする
3. テストをセットアップする
4. 設計を行う（列名特定方針、例外処理方針を明文化）
5. 先に要件を満たすテストを書く（ルール判定、clamp、空欄0扱い等）
6. 実装する
7. リファクタリングを行う
8. すべての品質チェックがパスすることを確認する
9. README.md に仕様をまとめる

---

## 9. 注意点（ユーザー確認が必要になり得る事項）
- Amazonの実ファイルで、以下の **ヘッダー名がどれに該当するか** を確認すること：
  - 「商品ターゲティング」判定に使う列（B列相当）
  - ROAS 列、クリック数 列、入札額 列
- 例として、ユーザーが用意するファイル名：
  - bulk-af6jc16k6midk-20260211-20260218-1771394817440.xlsx

---

## 10. 命令
上記のタスクを進めてください。
